!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("nearley"),require("yaml"),require("moo")):"function"==typeof define&&define.amd?define(["nearley","yaml","moo"],t):"object"==typeof exports?exports.publicodes=t(require("nearley"),require("yaml"),require("moo")):e.publicodes=t(e.nearley,e.yaml,e.moo)}(this,(function(e,t,n){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(e,t,n){"use strict";n.d(t,"g",(function(){return l})),n.d(t,"f",(function(){return c})),n.d(t,"b",(function(){return s})),n.d(t,"h",(function(){return p})),n.d(t,"e",(function(){return d})),n.d(t,"i",(function(){return f})),n.d(t,"c",(function(){return b})),n.d(t,"a",(function(){return m})),n.d(t,"d",(function(){return v})),n.d(t,"k",(function(){return O})),n.d(t,"j",(function(){return j}));var r=n(1);function a(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=["depuis","depuis le","depuis la","à partir de","à partir du","du"],r=["jusqu'à","jusqu'au","jusqu'à la","avant","avant le","avant la","au"];if(!n.concat(r,["le","en"]).includes(e))throw new SyntaxError("Le mot clé '".concat(e,"' n'est pas valide. Les mots clés possible sont les suivants :\n\t ").concat(n.join(", ")));if("le"===e)return{start:t,end:t};if("en"===e)return{start:null,end:null};if(n.includes(e))return{start:t,end:null};if(r.includes(e))return{start:null,end:t};throw new Error("Non implémenté")}function c(e,t){return b((e,t)=>t&&e,t,s(!0,e))}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{start:null,end:null},n=[i(i({},t),{},{value:e})];return null!=t.start&&n.unshift({start:null,end:Object(r.f)(t.start,-1),value:!1}),null!=t.end&&n.push({start:Object(r.f)(t.end,1),end:null,value:!1}),n}function p(e){return[{start:null,end:null,value:e}]}function d(e,t){return t.map(t=>{var{start:n,end:r,value:a}=t;return{start:n,end:r,value:e(a)}})}function f(e,t){return t.some(t=>{var{start:n,end:r,value:a}=t;return e(a)})}function b(e,t,n){return d(t=>{var[n,r]=t;return e(n,r)},O(t,n))}function m(e){return e.reduce((e,t)=>b((e,t)=>[...e,t],e,t),p([]))}function v(e){if(!("temporalValue"in e))return p(e);var t=e,{temporalValue:n}=t,r=a(t,["temporalValue"]);return d(e=>i(i({},r),{},{nodeValue:e}),n)}function O(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(!e.length&&!t.length)return n;var[a,...o]=e,[u,...l]=t;console.assert(a.start===u.start);var c=y(a.end,u.end);if(0===c)return O(o,l,[...n,i(i({},a),{},{value:[a.value,u.value]})]);if(c>0)return console.assert(null!==u.end),O([i(i({},a),{},{start:Object(r.f)(u.end,1)}),...o],l,[...n,i(i({},u),{},{value:[a.value,u.value]})]);if(c<0)return console.assert(null!==a.end),O(o,[i(i({},u),{},{start:Object(r.f)(a.end,1)}),...l],[...n,i(i({},a),{},{value:[a.value,u.value]})]);throw new EvalError("All case should have been covered")}function y(e,t){return e==t?0:null==e?1:null==t||Object(r.a)(e)<Object(r.a)(t)?-1:1}function j(e,t){if(!(e=e.filter(e=>{var{value:t}=e;return!1!==t})).length)return!1;if(1===e.length)return e[0].value;if(e.some(e=>{var{value:t}=e;return null==t}))return null;var n=e,a=n[0],o=n[n.length-1];if(null==a.start||null==o.end)return null!=a.start?o.value:null!=o.end?a.value:(a.value+o.value)/2;var i=0;return n.map(e=>{var{start:n,end:a,value:o}=e;[n,a]=[n,a];var u=0;return u=(null==t?void 0:t.denominators.includes("mois"))?Object(r.d)(n,a):(null==t?void 0:t.denominators.includes("année"))?Object(r.e)(n,a):Object(r.c)(n,a),i+=u,o*u}).reduce((e,t)=>e+t/i,0)}},function(e,t,n){"use strict";function r(e){var[t,n,r]=e.split("/");return r||([t,n,r]=["01",t,n]),o(+r,+n,+t)}n.d(t,"h",(function(){return r})),n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return u})),n.d(t,"f",(function(){return l})),n.d(t,"g",(function(){return c})),n.d(t,"c",(function(){return s})),n.d(t,"d",(function(){return p})),n.d(t,"e",(function(){return d}));var a=e=>+e<10?"0".concat(e):""+e;function o(e,t,n){var r=new Date(+e,+t-1,+n);if(!+r||r.getDate()!==+n)throw new SyntaxError("La date ".concat(n,"/").concat(t,"/").concat(e," n'est pas valide"));return"".concat(a(n),"/").concat(a(t),"/").concat(a(e))}function i(e){var[t,n,a]=r(e).split("/"),o=new Date(+a,+n-1,+t);return o.setMinutes(o.getMinutes()-o.getTimezoneOffset()),o}function u(e){return o(e.getFullYear(),e.getMonth()+1,e.getDate())}function l(e,t){var n=new Date(i(e));return n.setDate(n.getDate()+t),u(n)}function c(e){return+e.slice(-4)}function s(e,t){return 1+(i(e).getTime()-i(t).getTime())/864e5}function p(e,t){var[n,r,a]=e.split("/").map(e=>+e),[o,i,u]=t.split("/").map(e=>+e);return i-r+12*(u-a)-(n-1)/new Date(a,r,0).getDate()+o/new Date(u,i,0).getDate()}function d(e,t){return s(e,t)/365.25}},function(e,t){},function(t,n){t.exports=e},function(e,t,n){!function(){function t(e){return e[0]}var{string:r,date:a,variable:o,temporalNumericValue:i,binaryOperation:u,unaryOperation:l,boolean:c,number:s,numberWithUnit:p,JSONObject:d}=n(6),f=n(7),b="".concat("[a-zA-ZÀ-ſ€$%]","(?:[-']?").concat("[a-zA-ZÀ-ſ0-9'°]","+)*"),m="(?:".concat(b,"|").concat("[a-zA-ZÀ-ſ0-9'°]","+)"),v="".concat(b,"(?:[,\\s]?").concat(m,"+)*"),O="\\| ".concat(b,"(?:[\\s]").concat(b,")*"),y=f.compile({"(":"(",")":")","[":"[","]":"]",comparison:[">","<",">=","<=","=","!="],infinity:"Infinity",colon:" : ",date:new RegExp("(?:(?:0?[1-9]|[12][0-9]|3[01])\\/)?(?:0?[1-9]|1[012])\\/\\d{4}"),periodWord:new RegExp(O),words:new RegExp(v),number:new RegExp("-?(?:[1-9][0-9]+|[0-9])(?:\\.[0-9]+)?"),string:/'.*'/,JSONObject:/{.*}/,additionSubstraction:/[\+-]/,multiplicationDivision:["*","/"],dot:" . ",".":".",letterOrNumber:new RegExp("[a-zA-ZÀ-ſ0-9'°]"),space:{match:/[\s]+/,lineBreaks:!0}}),j=e=>({value:e.map(e=>e&&e.value).join("")}),g=e=>{var[t,n]=e;return Array.isArray(n)?j([t,...n]):t},h={Lexer:y,ParserRules:[{name:"main",symbols:["Comparison"],postprocess:t},{name:"main",symbols:["NumericValue"],postprocess:t},{name:"main",symbols:["Date"],postprocess:t},{name:"main",symbols:["NonNumericTerminal"],postprocess:t},{name:"main",symbols:["JSONObject"],postprocess:t},{name:"NumericValue",symbols:["AdditionSubstraction"],postprocess:t},{name:"NumericValue",symbols:["Negation"],postprocess:t},{name:"NumericValue",symbols:["TemporalNumericValue"],postprocess:t},{name:"TemporalNumericValue",symbols:["NumericValue",y.has("space")?{type:"space"}:space,y.has("periodWord")?{type:"periodWord"}:O,y.has("space")?{type:"space"}:space,y.has("date")?{type:"date"}:a],postprocess:e=>{var[t,,n,,r]=e;return i(t,n,a([r]))}},{name:"TemporalNumericValue",symbols:["NumericValue",y.has("space")?{type:"space"}:space,y.has("periodWord")?{type:"periodWord"}:O,y.has("colon")?{type:"colon"}:colon,"Date"],postprocess:e=>{var[t,,n,,r]=e;return i(t,n,r)}},{name:"NumericTerminal",symbols:["Variable"],postprocess:t},{name:"NumericTerminal",symbols:["number"],postprocess:t},{name:"Negation",symbols:[{literal:"-"},y.has("space")?{type:"space"}:space,"Parentheses"],postprocess:l("calculation")},{name:"Parentheses",symbols:[{literal:"("},"NumericValue",{literal:")"}],postprocess:e=>{var[,t]=e;return t}},{name:"Parentheses",symbols:["NumericTerminal"],postprocess:t},{name:"Date",symbols:["Variable"],postprocess:t},{name:"Date",symbols:[y.has("date")?{type:"date"}:a],postprocess:a},{name:"Comparison",symbols:["Comparable",y.has("space")?{type:"space"}:space,y.has("comparison")?{type:"comparison"}:comparison,y.has("space")?{type:"space"}:space,"Comparable"],postprocess:u("comparison")},{name:"Comparison",symbols:["Date",y.has("space")?{type:"space"}:space,y.has("comparison")?{type:"comparison"}:comparison,y.has("space")?{type:"space"}:space,"Date"],postprocess:u("comparison")},{name:"Comparable$subexpression$1",symbols:["AdditionSubstraction"]},{name:"Comparable$subexpression$1",symbols:["NonNumericTerminal"]},{name:"Comparable",symbols:["Comparable$subexpression$1"],postprocess:e=>{var[[t]]=e;return t}},{name:"NonNumericTerminal",symbols:["boolean"],postprocess:t},{name:"NonNumericTerminal",symbols:["string"],postprocess:t},{name:"Variable$ebnf$1",symbols:[]},{name:"Variable$ebnf$1$subexpression$1",symbols:[y.has("dot")?{type:"dot"}:dot,y.has("words")?{type:"words"}:v],postprocess:e=>{var[,t]=e;return t}},{name:"Variable$ebnf$1",symbols:["Variable$ebnf$1","Variable$ebnf$1$subexpression$1"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Variable",symbols:[y.has("words")?{type:"words"}:v,"Variable$ebnf$1"],postprocess:o},{name:"UnitDenominator$ebnf$1$subexpression$1",symbols:[y.has("space")?{type:"space"}:space]},{name:"UnitDenominator$ebnf$1",symbols:["UnitDenominator$ebnf$1$subexpression$1"],postprocess:t},{name:"UnitDenominator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitDenominator",symbols:["UnitDenominator$ebnf$1",{literal:"/"},y.has("words")?{type:"words"}:v],postprocess:j},{name:"UnitNumerator$ebnf$1$subexpression$1",symbols:[{literal:"."},y.has("words")?{type:"words"}:v]},{name:"UnitNumerator$ebnf$1",symbols:["UnitNumerator$ebnf$1$subexpression$1"],postprocess:t},{name:"UnitNumerator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitNumerator",symbols:[y.has("words")?{type:"words"}:v,"UnitNumerator$ebnf$1"],postprocess:g},{name:"Unit$ebnf$1",symbols:["UnitNumerator"],postprocess:t},{name:"Unit$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Unit$ebnf$2",symbols:[]},{name:"Unit$ebnf$2",symbols:["Unit$ebnf$2","UnitDenominator"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Unit",symbols:["Unit$ebnf$1","Unit$ebnf$2"],postprocess:g},{name:"AdditionSubstraction",symbols:["AdditionSubstraction",y.has("space")?{type:"space"}:space,y.has("additionSubstraction")?{type:"additionSubstraction"}:additionSubstraction,y.has("space")?{type:"space"}:space,"MultiplicationDivision"],postprocess:u("calculation")},{name:"AdditionSubstraction",symbols:["MultiplicationDivision"],postprocess:t},{name:"MultiplicationDivision",symbols:["MultiplicationDivision",y.has("space")?{type:"space"}:space,y.has("multiplicationDivision")?{type:"multiplicationDivision"}:multiplicationDivision,y.has("space")?{type:"space"}:space,"Parentheses"],postprocess:u("calculation")},{name:"MultiplicationDivision",symbols:["Parentheses"],postprocess:t},{name:"boolean",symbols:[{literal:"oui"}],postprocess:c(!0)},{name:"boolean",symbols:[{literal:"non"}],postprocess:c(!1)},{name:"number",symbols:[y.has("number")?{type:"number"}:s],postprocess:s},{name:"number",symbols:[y.has("infinity")?{type:"infinity"}:infinity],postprocess:s},{name:"number$ebnf$1$subexpression$1",symbols:[y.has("space")?{type:"space"}:space]},{name:"number$ebnf$1",symbols:["number$ebnf$1$subexpression$1"],postprocess:t},{name:"number$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"number",symbols:[y.has("number")?{type:"number"}:s,"number$ebnf$1","Unit"],postprocess:p},{name:"string",symbols:[y.has("string")?{type:"string"}:r],postprocess:r},{name:"JSONObject",symbols:[y.has("JSONObject")?{type:"JSONObject"}:d],postprocess:d}],ParserStart:"main"};void 0!==e.exports?e.exports=h:window.grammar=h}()},function(e,n){e.exports=t},function(e,t,n){"use strict";n.r(t),n.d(t,"binaryOperation",(function(){return l})),n.d(t,"unaryOperation",(function(){return c})),n.d(t,"temporalNumericValue",(function(){return s})),n.d(t,"variable",(function(){return p})),n.d(t,"JSONObject",(function(){return d})),n.d(t,"number",(function(){return f})),n.d(t,"numberWithUnit",(function(){return b})),n.d(t,"date",(function(){return m})),n.d(t,"boolean",(function(){return v})),n.d(t,"string",(function(){return O}));var r=n(1),a=n(0);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=e=>t=>{var[n,,r,,a]=t;return{[r]:{operationType:e,explanation:[n,a]}}},c=e=>t=>{var[n,,r]=t;return{[n]:{operationType:e,explanation:[f([{value:"0"}]),r]}}},s=(e,t,n)=>({temporalValue:{explanation:e,period:Object(a.g)(t.value.slice(2),n)}}),p=(e,t,n)=>{var[r,a]=e,o=[r,...a].map(e=>{var{value:t}=e;return t});return!a.length&&["oui","non"].includes(r)?n:{variable:o.join(" . ")}},d=e=>{var[{value:t}]=e;console.log(t)},f=e=>{var[{value:t}]=e;return{constant:{type:"number",nodeValue:parseFloat(t)}}},b=e=>i(i({},f(e)),{},{"unité":e[2].value}),m=e=>{var[{value:t}]=e;return{constant:{type:"date",nodeValue:Object(r.h)(t)}}},v=e=>()=>({constant:{type:"boolean",nodeValue:e}}),O=e=>{var[{value:t}]=e;return{constant:{type:"string",nodeValue:t.slice(1,-1)}}}},function(e,t){e.exports=n},function(e,t,n){"use strict";n.r(t),n.d(t,"reduceAST",(function(){return d})),n.d(t,"transformAST",(function(){return p})),n.d(t,"Evaluation",(function(){return T.Evaluation})),n.d(t,"Unit",(function(){return T.Unit})),n.d(t,"capitalise0",(function(){return Tn})),n.d(t,"formatValue",(function(){return Ln})),n.d(t,"simplifyNodeUnit",(function(){return be})),n.d(t,"serializeEvaluation",(function(){return lr})),n.d(t,"parseUnit",(function(){return B})),n.d(t,"serializeUnit",(function(){return G})),n.d(t,"parsePublicodes",(function(){return or})),n.d(t,"utils",(function(){return r})),n.d(t,"Rule",(function(){})),n.d(t,"RuleNode",(function(){})),n.d(t,"ASTNode",(function(){return T.ASTNode})),n.d(t,"EvaluatedNode",(function(){return T.EvaluatedNode})),n.d(t,"default",(function(){return fr})),n.d(t,"UNSAFE_isNotApplicable",(function(){return br}));var r={};n.r(r),n.d(r,"nameLeaf",(function(){return Jt})),n.d(r,"encodeRuleName",(function(){return Bt})),n.d(r,"decodeRuleName",(function(){return Zt})),n.d(r,"ruleParents",(function(){return Gt})),n.d(r,"disambiguateRuleReference",(function(){return Yt})),n.d(r,"ruleWithDedicatedDocumentationPage",(function(){return Ht}));class a extends Error{}function o(e,t,n){throw new a('\n[ Erreur syntaxique ]\n➡️  Dans la règle "'.concat(e,'"\n✖️  ').concat(t,"\n    ").concat(n?n.message:"","\n"))}function i(e,t,n,r){e.warn('\n[ Avertissement ]\n➡️  Dans la règle "'.concat(t,'"\n⚠️  ').concat(n,"\n").concat(r?"ℹ️  ".concat(r.message):"","\n"))}class u extends a{constructor(e){super("\nErreur interne du moteur.\n\nCette erreur est le signe d'un bug dans publicodes. Pour nous aider à le résoudre, vous pouvez copier ce texte dans un nouveau ticket : https://github.com/betagouv/mon-entreprise/issues/new.\n\npayload:\n\t".concat(JSON.stringify(e,null,2),"\n"))}}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return function t(n){var r=e(n,t);return!1===r?n:void 0===r?b(t,n):r}}function d(e,t,n){return function n(r,a){var o=e(r,a,n.bind(null,t));return void 0===o?function(e){var t=[];return b(e=>(t.push(e),e),e),t}(a).reduce(n,r):o}(t,n)}function f(e,t){return Object.fromEntries(Object.entries(t).map(t=>{var[n,r]=t;return[n,e(r)]}))}var b=(e,t)=>{switch(t.nodeKind){case"rule":return m(e,t);case"reference":case"constant":return O(e,t);case"applicable si":case"non applicable si":return y(e,t);case"arrondi":return D(e,t);case"barème":case"taux progressif":case"grille":return g(e,t);case"somme":case"une de ces conditions":case"une possibilité":case"toutes ces conditions":case"minimum":case"maximum":return h(e,t);case"durée":return P(e,t);case"inversion":return V(e,t);case"operation":return w(e,t);case"par défaut":return x(e,t);case"plancher":return S(e,t);case"plafond":return N(e,t);case"produit":return E(e,t);case"recalcul":return $(e,t);case"abattement":return k(e,t);case"nom dans la situation":return K(e,t);case"synchronisation":return A(e,t);case"unité":return R(e,t);case"variations":return U(e,t);case"variable temporelle":return M(e,t);case"replacementRule":return v(e,t);default:throw new u(t)}},m=(e,t)=>c(c({},t),{},{replacements:t.replacements.map(e),suggestions:Object.fromEntries(Object.entries(t.suggestions).map(t=>{var[n,r]=t;return[n,e(r)]})),explanation:{parent:t.explanation.parent&&e(t.explanation.parent),valeur:e(t.explanation.valeur)}}),v=(e,t)=>c(c({},t),{},{definitionRule:e(t.definitionRule),replacedReference:e(t.replacedReference),replacementNode:e(t.replacementNode),whiteListedNames:t.whiteListedNames.map(e),blackListedNames:t.blackListedNames.map(e)}),O=(e,t)=>t,y=(e,t)=>c(c({},t),{},{explanation:{condition:e(t.explanation.condition),valeur:e(t.explanation.valeur)}});function j(e,t){return t.map(t=>c(c(c(c({},t),t.plafond&&{plafond:e(t.plafond)}),"montant"in t&&{montant:e(t.montant)}),"taux"in t&&{taux:e(t.taux)}))}var g=(e,t)=>c(c({},t),{},{explanation:{assiette:e(t.explanation.assiette),multiplicateur:e(t.explanation.multiplicateur),tranches:j(e,t.explanation.tranches)}}),h=(e,t)=>c(c({},t),{},{explanation:t.explanation.map(e)}),w=(e,t)=>c(c({},t),{},{explanation:[e(t.explanation[0]),e(t.explanation[1])]}),P=(e,t)=>c(c({},t),{},{explanation:{depuis:e(t.explanation.depuis),"jusqu'à":e(t.explanation["jusqu'à"])}}),V=(e,t)=>c(c({},t),{},{explanation:c(c({},t.explanation),{},{inversionCandidates:t.explanation.inversionCandidates.map(e)})}),x=(e,t)=>c(c({},t),{},{explanation:{valeur:e(t.explanation.valeur),"parDéfaut":e(t.explanation.parDéfaut)}}),D=(e,t)=>c(c({},t),{},{explanation:{valeur:e(t.explanation.valeur),arrondi:e(t.explanation.arrondi)}}),S=(e,t)=>c(c({},t),{},{explanation:{valeur:e(t.explanation.valeur),plancher:e(t.explanation.plancher)}}),N=(e,t)=>c(c({},t),{},{explanation:{valeur:e(t.explanation.valeur),plafond:e(t.explanation.plafond)}}),E=(e,t)=>c(c({},t),{},{explanation:{assiette:e(t.explanation.assiette),taux:e(t.explanation.taux),facteur:e(t.explanation.facteur),plafond:e(t.explanation.plafond)}}),$=(e,t)=>c(c({},t),{},{explanation:{amendedSituation:t.explanation.amendedSituation.map(t=>{var[n,r]=t;return[e(n),e(r)]}),recalcul:e(t.explanation.recalcul)}}),k=(e,t)=>c(c({},t),{},{explanation:{assiette:e(t.explanation.assiette),abattement:e(t.explanation.abattement)}}),K=(e,t)=>c(c({},t),{},{explanation:c(c(c({},t.explanation),t.explanation.situationValeur&&{situationValeur:e(t.explanation.situationValeur)}),{},{valeur:e(t.explanation.valeur)})}),A=(e,t)=>c(c({},t),{},{explanation:c(c({},t.explanation),{},{data:e(t.explanation.data)})}),R=(e,t)=>c(c({},t),{},{explanation:e(t.explanation)}),U=(e,t)=>c(c({},t),{},{explanation:t.explanation.map(t=>{var{condition:n,consequence:r}=t;return{condition:e(n),consequence:e(r)}})}),M=(e,t)=>c(c({},t),{},{explanation:{period:{end:t.explanation.period.end&&e(t.explanation.period.end),start:t.explanation.period.start&&e(t.explanation.period.start)},value:e(t.explanation.value)}}),T=n(2),q={constant:e=>e};function L(e,t){var n;if(null!==(n=q)&&void 0!==n||(q={}),q[e])throw Error("Multiple evaluation functions registered for the nodeKind [4m".concat(e));q[e]=t}var _=n(3),I=n(4),C=n.n(I),F=n(0);function z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function W(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?z(Object(n),!0).forEach((function(t){J(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):z(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function J(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var B=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e,[n,...r]=e.split("/").map(e=>e.trim()),a={numerators:n.split(".").filter(Boolean).map(e=>t(e)),denominators:r.map(e=>t(e))};return a},Z=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e=>e;return e.sort().map(e=>n(e,t)).join(".")},G=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e=>e;if(null===e||"object"!=typeof e)return"string"==typeof e?n(e,t):e;var r=ee(e),{numerators:a=[],denominators:o=[]}=r,i=a.length>0,u=o.length>0,l=i||u?i&&!u?Z(a,t,n):!i&&u?"/".concat(Z(o,1,n)):"".concat(Z(a,2,n)," / ").concat(Z(o,1,n)):"";return l},Y={numerators:[],denominators:[]},H=(e,t)=>{if("/"===e){if(2!==t.length)throw new Error("Infer units of a division with units.length !== 2)");return H("*",[t[0]||Y,{numerators:(t[1]||Y).denominators,denominators:(t[1]||Y).numerators}])}var n=t.filter(Boolean);return n.length<=1?n[0]:"*"===e?ee({numerators:n.flatMap(e=>{var t;return null!==(t=null==e?void 0:e.numerators)&&void 0!==t?t:[]}),denominators:n.flatMap(e=>{var t;return null!==(t=null==e?void 0:e.denominators)&&void 0!==t?t:[]})}):"-"===e||"+"===e?t.find(e=>e):void 0},Q=(e,t)=>Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((n,r)=>e[r]===t[r]):e===t,X=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q;return n=>{var r=n.findIndex(n=>t(n,e));return n.filter((e,t)=>t!==r)}},ee=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q;return[...e.numerators,...e.denominators].reduce((e,n)=>{var{numerators:r,denominators:a}=e;return r.find(e=>t(n,e))&&a.find(e=>t(n,e))?{numerators:X(n,t)(r),denominators:X(n,t)(a)}:{numerators:r,denominators:a}},e)},te={"mois/an":12,"jour/an":365,"jour/mois":365/12,"trimestre/an":4,"mois/trimestre":3,"jour/trimestre":91.25,"€/k€":1e3,"g/kg":1e3,"mg/g":1e3,"mg/kg":10**6};function ne(e,t){return te["".concat(t,"/").concat(e)]||te["".concat(e,"/").concat(t)]&&1/te["".concat(e,"/").concat(t)]}function re(e,t){var n=100**(t.filter(e=>"%"===e).length-e.filter(e=>"%"===e).length);return[n]=e.reduce((e,t)=>{var[n,r]=e,a=r.findIndex(e=>!!ne(t,e));return[n*(ne(t,r[a])||1),[...r.slice(0,a+1),...r.slice(a+1)]]},[n,t]),n}function ae(e,t,n){if(!se(e,t))throw new Error("Impossible de convertir l'unité '".concat(G(e),"' en '").concat(G(t),"'"));if(!n)return n;if(void 0===e)return n;var[r,a]=le(e||Y),[o,i]=le(t||Y);return ue(n*a/i*re(r.numerators,o.numerators)*re(o.denominators,r.denominators))}var oe=function(e){return Object.keys(e).reduce((e,t)=>{var[n,r]=t.split("/"),a=e.findIndex(e=>e.has(n)),o=e.findIndex(e=>e.has(r));if(a>-1&&o>-1&&a!==o)throw Error("Invalid ratio ".concat(t));return-1===a&&-1===o?e.push(new Set([n,r])):a>-1?e[a].add(r):o>-1&&e[o].add(n),e},[])}(te);function ie(e,t){return e===t||oe.some(n=>n.has(e)&&n.has(t))}function ue(e){return+e.toFixed(16)}function le(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=re(e.numerators,e.denominators);return[ee(ce(e),ie),t?ue(t*n):t]}var ce=e=>({numerators:e.numerators.filter(e=>"%"!==e),denominators:e.denominators.filter(e=>"%"!==e)});function se(e,t){if(null==e||null==t)return!0;var n,[r,a,o,i]=[e.numerators,e.denominators,t.numerators,t.denominators].map(e=>e.reduce((e,t)=>{var n,r=oe.findIndex(e=>e.has(t)),a=-1===r?t:""+r;return W(W({},e),{},{[a]:1+(null!==(n=e[a])&&void 0!==n?n:0)})},{})),u=[r,a,o,i].map(Object.keys).flat();return(n=u,[...new Set(n)]).every(e=>(r[e]||0)-(a[e]||0)==(o[e]||0)-(i[e]||0)||"%"===e)}function pe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function de(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pe(Object(n),!0).forEach((function(t){fe(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function fe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function be(e){return e.unit?me(function(e){var{numerators:t,denominators:n}=ee(e,ie);return t.length&&t.every(e=>"%"===e)?{numerators:["%"],denominators:n}:ce({numerators:t,denominators:n})}(e.unit),e):e}function me(e,t){var n=t.temporalValue&&t.unit?Object(F.e)(n=>ae(t.unit,e,n),t.temporalValue):t.temporalValue;return de(de(de({},t),{},{nodeValue:t.unit&&"number"==typeof t.nodeValue?ae(t.unit,e,t.nodeValue):t.nodeValue},n&&{temporalValue:n}),{},{unit:e})}function ve(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Oe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ve(Object(n),!0).forEach((function(t){ye(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ve(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ye(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var je=e=>"missingVariables"in e?e.missingVariables:{},ge=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.fromEntries(Object.entries(e).map(e=>{var[t,n]=e;return[t,n+1e-4]}))},he=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.fromEntries([...Object.keys(e),...Object.keys(t)].map(n=>{var r,a;return[n,(null!==(r=e[n])&&void 0!==r?r:0)+(null!==(a=t[n])&&void 0!==a?a:0)]}))},we=e=>e.map(je).reduce(he,{});function Pe(e,t){var n=e.find(e=>!!e.unit);return n?e.map(e=>{try{return me(n.unit,e)}catch(t){return i(this.options.logger,this.cache._meta.ruleStack[0],"Les unités des éléments suivants sont incompatibles entre elles : \n\t\t".concat((null==e?void 0:e.name)||(null==e?void 0:e.rawNode),"\n\t\t").concat((null==n?void 0:n.name)||(null==n?void 0:n.rawNode),"'"),t),e}}):e}var Ve=(e,t)=>function(n){var r=this.evaluate.bind(this),a=Pe.call(this,n.explanation.map(r),n.name),o=Object(F.a)(a.map(e=>{var{temporalValue:t,nodeValue:n}=e;return null!=t?t:Object(F.h)(n)})),i=Object(F.e)(n=>n.some(e=>null===e)?null:n.reduce(e,t),o),u=Oe(Oe({},n),{},{missingVariables:we(a),explanation:a},a[0]&&{unit:a[0].unit});return 1===i.length?Oe(Oe({},u),{},{nodeValue:i[0].value}):Oe(Oe({},u),{},{temporalValue:i,nodeValue:Object(F.j)(i)})},xe=e=>({nodeValue:e,type:typeof e,isDefault:!0,nodeKind:"constant"}),De=(e,t,n)=>Object.fromEntries(Object.entries(e).map(e=>{var[r,a]=e;if(null==t[r]&&!a)throw new Error("Il manque une clé '".concat(r,"' dans ").concat(JSON.stringify(t)," "));return[r,null!=t[r]?Zn(t[r],n):a]}));function Se(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ne(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Se(Object(n),!0).forEach((function(t){Ee(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Se(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ee(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function $e(e,t){return{explanation:{assiette:Zn(e.valeur,t),abattement:Zn(e.abattement,t)},nodeKind:$e.nom}}function ke(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ke(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ke(Object(n),!0).forEach((function(t){Ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ke(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ae(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}$e.nom="abattement",L($e.nom,(function(e){var t=this.evaluate(e.explanation.assiette),n=this.evaluate(e.explanation.abattement),r="%"===G(n.unit);if(t.unit&&!r)try{n=me(t.unit,n)}catch(e){i(this.options.logger,this.cache._meta.ruleStack[0],"Impossible de convertir les unités de l'allègement entre elles",e)}var a=t.nodeValue,o=n.nodeValue,u=n?null==a?null:null==o?0==a?0:null:"%"===G(n.unit)?Math.max(0,a-o/100*a):Math.max(0,a-o):a;return Ne(Ne({},e),{},{nodeValue:u,unit:t.unit,missingVariables:we([t,n]),explanation:{assiette:t,abattement:n}})}));function Re(e,t){return{explanation:{valeur:Zn(e.valeur,t),condition:Zn(e[Re.nom],t)},nodeKind:Re.nom}}function Ue(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Me(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ue(Object(n),!0).forEach((function(t){Te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ue(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Te(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function qe(e,t){return+e.toFixed(t)}Re.nom="applicable si",L(Re.nom,(function(e){var t=Ke({},e.explanation),n=this.evaluate(t.condition),r=t.valeur;return!1!==n.nodeValue&&(r=this.evaluate(r)),Ke(Ke({},e),{},{nodeValue:null==n.nodeValue||!1===n.nodeValue?n.nodeValue:"nodeValue"in r?r.nodeValue:null,explanation:{valeur:r,condition:n},missingVariables:he("missingVariables"in r?r.missingVariables:{},ge(n.missingVariables))},"unit"in r&&{unit:r.unit})}));function Le(e,t){return{explanation:{valeur:Zn(e.valeur,t),arrondi:Zn(e.arrondi,t)},nodeKind:Le.nom}}function _e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ie(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_e(Object(n),!0).forEach((function(t){Ce(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_e(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ce(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Le.nom="arrondi",L(Le.nom,(function(e){var t=be(this.evaluate(e.explanation.valeur)),n=t.nodeValue,r=e.explanation.arrondi;return!1!==n&&(r=this.evaluate(r)),Me(Me({},e),{},{nodeValue:"number"==typeof t.nodeValue&&"nodeValue"in r?"number"==typeof r.nodeValue?qe(t.nodeValue,r.nodeValue):!0===r.nodeValue?qe(t.nodeValue,0):null===r.nodeValue?null:t.nodeValue:t.nodeValue,explanation:{valeur:t,arrondi:r},missingVariables:we([t,r]),unit:t.unit})}));var Fe=(e,t)=>e.map((t,n)=>{var r;if(!t.plafond&&n>e.length)throw new SyntaxError("La tranche n°".concat(n," du barème n'a pas de plafond précisé. Seule la dernière tranche peut ne pas être plafonnée"));return Ie(Ie({},t),{},{plafond:null!==(r=t.plafond)&&void 0!==r?r:1/0})}).map(e=>Ie(Ie(Ie(Ie({},e),void 0!==e.taux?{taux:Zn(e.taux,t)}:{}),void 0!==e.montant?{montant:Zn(e.montant,t)}:{}),{},{plafond:Zn(e.plafond,t)}));function ze(e){var{multiplicateur:t,assiette:n,parsedTranches:r}=e;return r.reduce((e,r,a)=>{var[o,u]=e;if(u)return[[...o,Ie(Ie({},r),{},{isAfterActive:!0})],u];var l=this.evaluate(r.plafond),c=o[a-1]?o[a-1].plafond:{nodeValue:0},s=null===l.nodeValue||null===t.nodeValue?null:l.nodeValue*t.nodeValue;try{s=s===1/0||0===s?s:ae(H("*",[l.unit,t.unit]),n.unit,s)}catch(e){i(this.options.logger,this.cache._meta.ruleStack[0],"L'unité du plafond de la tranche n°".concat(a+1,"  n'est pas compatible avec celle l'assiette"),e)}var p,d,f,b,m=o[a-1]?o[a-1].plafondValue:0,v=null===m||null===n.nodeValue?null:m>n.nodeValue,O=[l,n,t,c];if(O.some(e=>null===e.nodeValue))return[[...o,Ie(Ie({},r),{},{plafond:l,plafondValue:s,plancherValue:m,nodeValue:null,isActive:null,isAfterActive:v,missingVariables:we(O)})],!1];o[a-1]&&m&&s<=m&&(p=this.options.logger,d=this.cache._meta.ruleStack[0],f="Le plafond de la tranche n°".concat(a+1," a une valeur inférieure à celui de la tranche précédente"),p.error("\n[ Erreur d'évaluation ]\n➡️  Dans la règle \"".concat(d,'"\n✖️  ').concat(f,"\n    ").concat(b?b.message:"","\n")));var y=Ie(Ie({},r),{},{plafond:l,plancherValue:m,plafondValue:s,isAfterActive:v,isActive:n.nodeValue>=m&&n.nodeValue<s});return[[...o,y],y.isActive]},[[],!1])[0]}function We(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Je(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?We(Object(n),!0).forEach((function(t){Be(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):We(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Be(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ze(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ge(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ze(Object(n),!0).forEach((function(t){Ye(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ze(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ye(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function He(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}L("barème",(function(e){var t=this.evaluate.bind(this),n=this.evaluate(e.explanation.assiette),r=this.evaluate(e.explanation.multiplicateur),a=Object(F.c)((t,n)=>ze.call(this,{parsedTranches:e.explanation.tranches,assiette:t,multiplicateur:n}),Object(F.d)(n),Object(F.d)(r)),o=Object(F.c)((e,n)=>function(e,t,n,r){return e.map(e=>{if(e.isAfterActive)return Je(Je({},e),{},{nodeValue:0});var r=n(e.taux);return[t.nodeValue,r.nodeValue,e.plafondValue,e.plancherValue].some(e=>null===e)?Je(Je({},e),{},{taux:r,nodeValue:null,missingVariables:we([r,e])}):Je(Je(Je({},e),{},{taux:r},"unit"in t&&{unit:t.unit}),{},{nodeValue:(Math.min(t.nodeValue,e.plafondValue)-e.plancherValue)*ae(r.unit,B(""),r.nodeValue),missingVariables:we([r,e])})})}(e,n,t,this.cache),a,Object(F.d)(n)),i=Object(F.e)(e=>e.reduce((e,t)=>{var{nodeValue:n}=t;return null==n?null:e+n},0),o);return Je(Je(Je({},e),{},{nodeValue:Object(F.j)(i)},i.length>1?{temporalValue:i}:{missingVariables:we(o[0].value)}),{},{explanation:Je({assiette:n,multiplicateur:r},o.length>1?{temporalTranches:o}:{tranches:o[0].value}),unit:n.unit})}));function Qe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qe(Object(n),!0).forEach((function(t){et(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function et(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function tt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function nt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tt(Object(n),!0).forEach((function(t){rt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function rt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("toutes ces conditions",(function(e){var[t,n]=e.explanation.reduce((e,t)=>{var[n,r]=e;if(!1===n)return[n,[...r,t]];var a=this.evaluate(t);return[null===n||null===a.nodeValue?null:!!a.nodeValue,[...r,a]]},[!0,[]]);return Xe(Xe({},e),{},{nodeValue:t,explanation:n,missingVariables:we(n)})}));L("une de ces conditions",(function(e){var t=e.explanation.reduce((e,t)=>{if(!0===e.nodeValue)return nt(nt({},e),{},{explanation:[...e.explanation,t]});if(null===e.nodeValue||!1===e.nodeValue){var n=this.evaluate(t);return{nodeValue:!!n.nodeValue||(null===n.nodeValue?null:e.nodeValue),missingVariables:n.nodeValue?{}:he(e.missingVariables,n.missingVariables),explanation:[...e.explanation,n]}}throw new u([t,e])},{nodeValue:!1,missingVariables:{},explanation:[]});return nt(nt({},e),t)}));var at=n(1);function ot(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function it(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ot(Object(n),!0).forEach((function(t){ut(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ot(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ut(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var lt=Object(at.b)(new Date),ct={depuis:xe(lt),"jusqu'à":xe(lt)};function st(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function pt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?st(Object(n),!0).forEach((function(t){dt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):st(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function dt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("durée",(function(e){var t,n=this.evaluate(e.explanation.depuis),r=this.evaluate(e.explanation["jusqu'à"]);if([n,r].some(e=>{var{nodeValue:t}=e;return null===t}))t=null;else{var[a,o]=[n.nodeValue,r.nodeValue].map(at.a);t=Math.max(0,Math.round((o.getTime()-a.getTime())/864e5))}var i=we([n,r]);return it(it({},e),{},{missingVariables:i,nodeValue:t,explanation:{depuis:n,"jusqu'à":r}})}));function ft(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function bt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ft(Object(n),!0).forEach((function(t){mt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ft(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function mt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("grille",(function(e){var t,n,r=this.evaluate.bind(this),a=this.evaluate(e.explanation.assiette),o=this.evaluate(e.explanation.multiplicateur),i=Object(F.c)((t,n)=>ze.call(this,{parsedTranches:e.explanation.tranches,assiette:t,multiplicateur:n}),Object(F.d)(a),Object(F.d)(o)),u=Object(F.e)(e=>((e,t)=>e.map(e=>{if(!1===e.isActive)return e;var n=t(e.montant);return pt(pt({},e),{},{montant:n,nodeValue:n.nodeValue,unit:n.unit,missingVariables:we([n,e])})}))(e,r),i),l=Object(F.e)(e=>{var t=e.find(e=>e.isActive);return t?[t]:!1===e[e.length-1].isAfterActive?[{nodeValue:!1}]:e.filter(e=>null===e.isActive)},u),c=Object(F.e)(e=>null===e[0].isActive?null:e[0].nodeValue,l);return pt(pt(pt({},e),{},{nodeValue:Object(F.j)(c)},c.length>1?{temporalValue:c}:{missingVariables:we(l[0].value)}),{},{explanation:pt(pt({},e.explanation),{},{assiette:a,multiplicateur:o},u.length>1?{temporalTranches:u}:{tranches:u[0].value}),unit:null!==(t=null===(n=l[0].value[0])||void 0===n?void 0:n.unit)&&void 0!==t?t:void 0})}));L("inversion",(function(e){var t=e.explanation.inversionCandidates.find(e=>null!=this.parsedSituation[e.dottedName]);if(void 0===t){var n=bt(bt({},Object.fromEntries(e.explanation.inversionCandidates.map(e=>[e.dottedName,1]))),{},{[e.explanation.ruleToInverse]:1});return bt(bt({},e),{},{missingVariables:n,nodeValue:null})}var r=this.evaluate(t),a="unit"in e?e.unit:r.unit,o=this.cache,i=bt({},this.parsedSituation),u=0;delete this.parsedSituation[t.dottedName];var l=n=>(u++,this.resetCache(),this.cache._meta=bt({},o._meta),this.parsedSituation[e.explanation.ruleToInverse]={unit:a,nodeKind:"unité",explanation:{nodeKind:"constant",nodeValue:n,type:"number"}},me(a,this.evaluate(t))),c=me(a,r).nodeValue,s=null,p=c,d=l(p),f=d.nodeValue,b=null!==f?p*c*(f>c?.9:1.2)/f:2e3,m=l(b),v=m.nodeValue,O=he(d.missingVariables,m.missingVariables);if(null!==f||null!==v){s=function(e,t,n){for(var r,a,o,i,u,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,p=t,d=n,f=p,b=e(p),m=e(d),v=b,O=void 0;c-- >0;){if(o=d-p,Math.abs(v)<Math.abs(m)&&(p=d,d=f,f=p,b=m,m=v,v=b),r=1e-15*Math.abs(d)+l/2,a=(f-d)/2,Math.abs(a)<=r||0===m)return d;if(Math.abs(o)>=r&&Math.abs(b)>Math.abs(m)){var y=void 0,j=void 0,g=f-d;p===f?(i=g*(y=m/b),u=1-y):(i=(j=m/b)*(g*(u=b/v)*(u-(y=m/v))-(d-p)*(y-1)),u=(u-1)*(y-1)*(j-1)),i>0?u=-u:i=-i,i<.75*g*u-Math.abs(r*u)/2&&i<Math.abs(o*u/2)&&(a=i/u)}Math.abs(a)<r&&(a=a>0?r:-r),p=d,b=m,((m=e(d+=a))>0&&v>0||m<0&&v<0)&&(f=p,v=b),Math.abs(m)<s&&(O=d)}return O}(e=>(e===p?f:e===b?v:l(e).nodeValue)-c,null!==v&&v<c&&(v>f||f>c)?b:null!==f&&f<c&&(f>v||v>c)?p:-1e6,null!==v&&v>c&&(v<f||f<c)?b:null!==f&&f>c&&(f<v||v<c)?p:1e8,.1,10,1)}return void 0===s&&(s=null,o._meta.inversionFail=!0),this.cache=o,this.parsedSituation=i,bt(bt({},e),{},{unit:a,nodeValue:s,explanation:bt(bt({},e.explanation),{},{inversionGoal:t,inversionNumberOfIterations:u}),missingVariables:O})}));L("maximum",Ve((e,t)=>!1===e?t:!1===t?e:null===e||null===t?null:Math.max(e,t),!1));function vt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ot(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vt(Object(n),!0).forEach((function(t){yt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function yt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("minimum",Ve((e,t)=>Math.min(e,t),1/0));function jt(e,t){return{explanation:{valeur:Zn(e.valeur,t),condition:Zn(e[jt.nom],t)},nodeKind:jt.nom}}function gt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ht(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?gt(Object(n),!0).forEach((function(t){wt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function wt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}jt.nom="non applicable si",L(jt.nom,(function(e){var t=this.evaluate(e.explanation.condition),n=e.explanation.valeur;return!1!==t.nodeValue&&null!==t.nodeValue||(n=this.evaluate(n)),Ot(Ot({},e),{},{nodeValue:null===t.nodeValue?null:!1===t.nodeValue&&("nodeValue"in n?n.nodeValue:null),explanation:{valeur:n,condition:t},missingVariables:he("missingVariables"in n?n.missingVariables:{},ge(t.missingVariables))},"unit"in n&&{unit:n.unit})}));function Pt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Vt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Pt(Object(n),!0).forEach((function(t){xt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Pt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function xt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("une possibilité",e=>ht(ht({},e),{},{nodeValue:null,missingVariables:{[e.context]:1}}));var Dt={"*":[(e,t)=>e*t,"×"],"/":[(e,t)=>e/t,"∕"],"+":[(e,t)=>e+t],"-":[(e,t)=>e-t,"−"],"<":[(e,t)=>e<t],"<=":[(e,t)=>e<=t,"≤"],">":[(e,t)=>e>t],">=":[(e,t)=>e>=t,"≥"],"=":[(e,t)=>e===t],"!=":[(e,t)=>e!==t,"≠"]},St=(e,t)=>(n,r)=>{var a=n.explanation.map(e=>Zn(e,r));return Vt(Vt({},n),{},{nodeKind:"operation",operationKind:e,operator:t||e,explanation:a})};L("operation",(function(e){var t,n,r=e.explanation.map(e=>this.evaluate(e)),[a,o]=r,u=we([a,o]);if(null==a.nodeValue||null==o.nodeValue)return Vt(Vt({},e),{},{nodeValue:null,explanation:r,missingVariables:u});if(!["∕","×"].includes(e.operator))try{a.unit&&"unit"in o?o=me(a.unit,o):o.unit&&(a=me(o.unit,a))}catch(t){i(this.options.logger,"Dans l'expression '".concat(e.operator,"', la partie gauche (unité: ").concat(G(a.unit),") n'est pas compatible avec la partie droite (unité: ").concat(G(o.unit),")"),t)}var l=Vt(Vt(Vt({},e),{},{explanation:r},("*"===e.operationKind||"/"===e.operationKind||"-"===e.operationKind||"+"===e.operationKind)&&{unit:H(e.operationKind,[a.unit,o.unit])}),{},{missingVariables:u}),c=Dt[e.operationKind][0],s=Object(F.c)((t,n)=>!(!["≠","="].includes(e.operator)&&!1===t&&!1===n)&&((!["<",">","≤","≥","∕","×"].includes(e.operator)||!1!==t&&!1!==n)&&(!1!==t&&!1!==n&&["≠","=","<",">","≤","≥"].includes(e.operator)&&[t,n].every(e=>{var t;return null===(t=e.match)||void 0===t?void 0:t.call(e,/[\d]{2}\/[\d]{2}\/[\d]{4}/)})?c(Object(at.a)(t),Object(at.a)(n)):c(t,n))),null!==(t=a.temporalValue)&&void 0!==t?t:Object(F.h)(a.nodeValue),null!==(n=o.temporalValue)&&void 0!==n?n:Object(F.h)(o.nodeValue)),p=Object(F.j)(s,l.unit);return Vt(Vt({},l),{},{nodeValue:p},s.length>1&&{temporalValue:s})}));var Nt=Object.fromEntries(Object.entries(Dt).map(e=>{var[t,[n,r]]=e;return[t,St(t,r)]}));function Et(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function $t(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Et(Object(n),!0).forEach((function(t){kt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Et(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function kt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Kt(e,t){return{explanation:{valeur:Zn(e.valeur,t),"parDéfaut":Zn(e["par défaut"],t)},nodeKind:Kt.nom}}function At(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Rt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?At(Object(n),!0).forEach((function(t){Ut(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):At(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ut(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Kt.nom="par défaut",L(Kt.nom,(function(e){var t=$t({},e.explanation),n=this.evaluate(t.valeur);return t.valeur=n,null===n.nodeValue&&(n=this.evaluate(t.parDéfaut),t.parDéfaut=n),$t($t({},e),{},{nodeValue:n.nodeValue,explanation:t,missingVariables:he(ge(t.valeur.missingVariables),"missingVariables"in t.parDéfaut?t.parDéfaut.missingVariables:{})},"unit"in n&&{unit:n.unit})}));function Mt(e,t){return{explanation:{valeur:Zn(e.valeur,t),plafond:Zn(e.plafond,t)},nodeKind:"plafond"}}function Tt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function qt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Tt(Object(n),!0).forEach((function(t){Lt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Tt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Lt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Mt.nom="plafond",L("plafond",(function(e){var t=this.evaluate(e.explanation.valeur),n=t.nodeValue,r=e.explanation.plafond;if(!1!==n){var a=this.evaluate(r);if(t.unit)try{r=me(t.unit,a)}catch(e){i(this.options.logger,this.cache._meta.ruleStack[0],"L'unité du plafond n'est pas compatible avec celle de la valeur à encadrer",e)}}return"number"==typeof n&&"nodeValue"in r&&"number"==typeof r.nodeValue&&n>r.nodeValue&&(n=r.nodeValue,r.isActive=!0),Rt(Rt(Rt({},e),{},{nodeValue:n},"unit"in t&&{unit:t.unit}),{},{explanation:{valeur:t,plafond:r},missingVariables:we([t,r])})}));function _t(e,t){return{explanation:{valeur:Zn(e.valeur,t),plancher:Zn(e.plancher,t)},nodeKind:"plancher"}}_t.nom="plancher",L("plancher",(function(e){var t=this.evaluate(e.explanation.valeur),n=t.nodeValue,r=e.explanation.plancher;if(!1!==n){var a=this.evaluate(r);if(t.unit)try{r=me(t.unit,a)}catch(e){i(this.options.logger,this.cache._meta.ruleStack[0],"L'unité du plancher n'est pas compatible avec celle de la valeur à encadrer",e)}}return"number"==typeof n&&"nodeValue"in r&&"number"==typeof r.nodeValue&&n<r.nodeValue&&(n=r.nodeValue,r.isActive=!0),qt(qt(qt({},e),{},{nodeValue:n},"unit"in t&&{unit:t.unit}),{},{explanation:{valeur:t,plancher:r},missingVariables:we([t,r])})}));var It,Ct={assiette:!1,taux:xe(1),facteur:xe(1),plafond:xe(1/0)},Ft=(e,t)=>({explanation:De(Ct,e,t),nodeKind:"produit"});L("produit",(It=function(e){var{assiette:t,taux:n,facteur:r,plafond:a}=e;if(t.unit)try{a=me(t.unit,a)}catch(e){i(this.options.logger,this.cache._meta.ruleStack[0],"Impossible de convertir l'unité du plafond du produit dans celle de l'assiette",e)}var o=![n,t,r].some(e=>!1===e.nodeValue)&&([n,t,r].some(e=>0===e.nodeValue)?0:[n,t,r].some(e=>null===e.nodeValue)?null:((e,t,n,r)=>Math.min(e,!1===r?1/0:r)*t*n)(t.nodeValue,n.nodeValue,r.nodeValue,a.nodeValue)),u=H("*",[t,n,r].map(e=>e.unit));return se(u,t.unit)&&(o=ae(u,t.unit,o),u=t.unit),be({nodeValue:o,unit:u,explanation:{plafondActif:t.nodeValue>a.nodeValue}})},function(e){var t=Object.fromEntries(Object.entries(e.explanation).map(e=>{var[t,n]=e;return[t,this.evaluate(n)]})),n=Object(F.e)(Object.fromEntries,Object(F.a)(Object.entries(t).map(e=>{var[t,n]=e;return Object(F.k)(Object(F.h)(t),Object(F.d)(n))}))),r=Object(F.e)(e=>{var t=It.call(this,e);return Oe(Oe({},t),{},{explanation:Oe(Oe({},e),t.explanation)})},n),a=Pe.call(this,r.map(e=>e.value),e.nodeKind).map((e,t)=>Oe(Oe({},r[t]),{},{value:be(e)})),o=Object(F.e)(e=>{var{nodeValue:t}=e;return t},a),i=Object(F.j)(o),u=Oe(Oe({},e),{},{nodeValue:i,unit:a[0].value.unit,explanation:t,missingVariables:we(Object.values(t))});return 1===a.length?Oe(Oe({},u),{},{explanation:a[0].value.explanation}):Oe(Oe({},u),{},{temporalValue:o,temporalExplanation:r})}));var zt=e=>e.split(" . "),Wt=e=>e.join(" . "),Jt=e=>{var t;return null===(t=zt(e).slice(-1))||void 0===t?void 0:t[0]},Bt=e=>null==e?void 0:e.replace(/\s\.\s/g,"/").replace(/-/g,"‑").replace(/\s/g,"-"),Zt=e=>e.replace(/\//g," . ").replace(/-/g," ").replace(/\u2011/g,"-");function Gt(e){var t=zt(e);return Array(t.length-1).fill(0).map((e,n)=>t.slice(0,n+1)).map(Wt).reverse()}function Yt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0,r=[t,...Gt(t),""].map(e=>e?e+" . "+n:n).sort((e,n)=>e===t?1:n===t?-1:0),a=r.find(t=>t in e);if(!a)throw o(t,"La référence '".concat(n,"' est introuvable.\n\tVérifiez que l'orthographe et l'espace de nom sont corrects")),new Error;return a}function Ht(e){return!0!==e.virtualRule&&"groupe"!==e.type&&"texte"!==e.type&&"paragraphe"!==e.type&&"notification"!==e.type}function Qt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qt(Object(n),!0).forEach((function(t){en(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function en(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function tn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function nn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tn(Object(n),!0).forEach((function(t){rn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function rn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function an(e,t){var n={situationKey:e[an.nom],valeur:Zn(e.valeur,t)};return{nodeKind:an.nom,explanation:n}}L("recalcul",(function(e){if(this.cache._meta.inRecalcul)return xe(!1);var t=e.explanation.amendedSituation.map(e=>{var[t,n]=e;return[this.evaluate(t),this.evaluate(n)]}).filter(e=>{var[t,n]=e;return t.nodeValue!==n.nodeValue||G(t.unit)!==G(n.unit)}),n=this.cache,r=Xt({},this.parsedSituation),a=Object.keys(t).length>0;a&&(this.resetCache(),this.cache._meta=Xt(Xt({},this.cache._meta),{},{inRecalcul:!0})),this.parsedSituation=Xt(Xt({},this.parsedSituation),Object.fromEntries(t.map(e=>{var[t,n]=e;return[Yt(this.parsedRules,t.contextDottedName,t.name),n]})));var o=this.evaluate(e.explanation.recalcul);return this.parsedSituation=r,a&&(this.cache=n),Xt(Xt(Xt({},e),{},{nodeValue:o.nodeValue,explanation:{recalcul:o,amendedSituation:t},missingVariables:o.missingVariables},"unit"in o&&{unit:o.unit}),o.temporalValue&&{temporalValue:o.temporalValue})})),an.nom="nom dans la situation",L(an.nom,(function(e){var t,n,r=nn({},e.explanation),a=r.situationKey;a in this.parsedSituation?(n=this.evaluate(this.parsedSituation[a]),r.situationValeur=n):(n=this.evaluate(r.valeur),r.valeur=n,delete r.situationValeur);var o=null!==(t=n.unit)&&void 0!==t?t:"unit"in r.valeur?r.valeur.unit:void 0,i=we([r.situationValeur,r.valeur].filter(Boolean));return nn(nn(nn({},e),{},{nodeValue:n.nodeValue,missingVariables:0===Object.keys(i).length&&null===n.nodeValue?{[a]:1}:i},void 0!==o&&{unit:o}),{},{explanation:r})}));function on(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function un(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?on(Object(n),!0).forEach((function(t){ln(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):on(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ln(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("somme",Ve((e,t)=>e+t,0));function cn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function sn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cn(Object(n),!0).forEach((function(t){pn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function pn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("synchronisation",(function(e){var t=this.evaluate(e.explanation.data),n=e.explanation.chemin.split(" . "),r=e=>n.reduce((e,t)=>e[t],e),a=null==t.nodeValue?null:r(t.nodeValue),o=null==a&&null!=t.nodeValue?r(t.explanation.defaultValue):a,i=un(un({},t.missingVariables),null===t.nodeValue?{[t.dottedName]:1}:{}),u=un(un({},e.explanation),{},{data:t});return un(un({},e),{},{nodeValue:o,explanation:u,missingVariables:i})}));function dn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function fn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?dn(Object(n),!0).forEach((function(t){bn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):dn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function bn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function mn(e,t){return{explanation:Zn(e.valeur,t),unit:B(e.unité,t.getUnitKey),nodeKind:mn.nom}}function vn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function On(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vn(Object(n),!0).forEach((function(t){yn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function yn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("taux progressif",(function(e){var t=this.evaluate.bind(this),n=this.evaluate(e.explanation.assiette),r=this.evaluate(e.explanation.multiplicateur),a=ze.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:r}),o=sn(sn({},e),{},{explanation:{tranches:a,assiette:n,multiplicateur:r},unit:B("%")}),i=a[a.length-1];if(a.every(e=>{var{isActive:t}=e;return!1===t})||i.isActive&&i.plafond.nodeValue===1/0){var u=me(B("%"),t(i.taux)),{nodeValue:l,missingVariables:c}=u;return i.taux=u,i.nodeValue=l,i.missingVariables=c,sn(sn({},o),{},{nodeValue:l,missingVariables:c})}if(a.every(e=>{var{isActive:t}=e;return!0!==t})||"number"!=typeof n.nodeValue)return sn(sn({},o),{},{nodeValue:null,missingVariables:we(a)});var s=a.findIndex(e=>{var{isActive:t}=e;return!0===t}),p=a[s];p.taux=me(B("%"),t(p.taux));var d=a[s-1];d&&(d.taux=me(B("%"),t(d.taux)),d.isActive=!0);var f=d?d.taux:p.taux,b=[f,p.taux,p];if(b.some(e=>null===e.nodeValue))return p.nodeValue=null,p.missingVariables=we(b),sn(sn({},o),{},{nodeValue:null,missingVariables:p.missingVariables});var m=f.nodeValue,v=p.taux.nodeValue,O=p.plancherValue,y=(v-m)/(p.plafondValue-O),j=m+(n.nodeValue-O)*y;return p.nodeValue=j,sn(sn({},o),{},{nodeValue:j,missingVariables:{}})})),mn.nom="unité",L(mn.nom,(function(e){var t=this.evaluate(e.explanation),n=t.nodeValue;if(!1!==n&&"unit"in e)try{n=ae(t.unit,e.unit,t.nodeValue)}catch(e){i(this.options.logger,this.cache._meta.ruleStack[0],"Erreur lors de la conversion d'unité explicite",e)}return fn(fn({},e),{},{nodeValue:n,explanation:t,missingVariables:t.missingVariables})}));function jn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function gn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?jn(Object(n),!0).forEach((function(t){hn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):jn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function hn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function wn(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}L("variable temporelle",(function(e){var t=e.explanation.period.start&&this.evaluate(e.explanation.period.start),n=e.explanation.period.end&&this.evaluate(e.explanation.period.end),r=this.evaluate(e.explanation.value),a={start:(null==t?void 0:t.nodeValue)||null,end:(null==n?void 0:n.nodeValue)||null},o=r.temporalValue?Object(F.f)(a,r.temporalValue):Object(F.b)(r.nodeValue,a);return On(On({},e),{},{nodeValue:Object(F.j)(o,r.unit),temporalValue:o,explanation:{period:{start:t,end:n},value:r}},"unit"in r&&{unit:r.unit})}));function Pn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Vn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Pn(Object(n),!0).forEach((function(t){xn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Pn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function xn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Dn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Sn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Dn(Object(n),!0).forEach((function(t){Nn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Dn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Nn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}L("variations",(function(e){var[t,n,r]=e.explanation.reduce((e,t,n)=>{var r,a,[o,u,l,c]=e,{condition:s,consequence:p}=t;if(!Object(F.i)(e=>!0!==e,c))return[o,[...u,{condition:s,consequence:p}],l,c];var d=this.evaluate(s),f=Object(F.c)((e,t)=>null===e?e:!e&&(null===t?null:!1!==t),c,null!==(r=d.temporalValue)&&void 0!==r?r:Object(F.h)(d.nodeValue));if(d.missingVariables=ge(d.missingVariables),!Object(F.i)(e=>!1!==e,f))return[o,[...u,{condition:d,consequence:p}],l,c];var b=this.evaluate(p);if(l)try{b=me(l,b)}catch(e){i(this.options.logger,this.cache._meta.ruleStack[0],"L'unité de la branche n° ".concat(n+1," du mécanisme 'variations' n'est pas compatible avec celle d'une branche précédente"),e)}var m=Object(F.c)((e,t)=>e&&t,f,null!==(a=b.temporalValue)&&void 0!==a?a:Object(F.h)(b.nodeValue)),v=(e,t)=>e||t;return[Object(F.c)(v,o,m),[...u,{condition:d,satisfied:!1!==d.nodeValue,consequence:b}],l||b.unit,Object(F.c)(v,c,f)]},[Object(F.h)(!1),[],void 0,Object(F.h)(!1)]),a=Object(F.j)(t,r),o=we(n.reduce((e,t)=>{var{condition:n,consequence:r}=t;return[...e,n,r]},[]));return gn(gn(gn({},e),{},{nodeValue:a},void 0!==r&&{unit:r}),{},{explanation:n,missingVariables:o},t.length>1&&{temporalValue:t})})),L("reference",(function(e){if(!e.dottedName)throw new u(e);var t=this.evaluate(this.parsedRules[e.dottedName]);return Vn(Vn({},e),{},{missingVariables:t.missingVariables,nodeValue:t.nodeValue},"unit"in t&&{unit:t.unit})}));var En=0,$n={};function kn(e,t){return e?(Array.isArray(e)?e:[e]).map(e=>{var n,r,a;"string"==typeof e&&(e={"règle":e});var o=Zn(e.règle,t),i=Zn(null!==(n=e.par)&&void 0!==n?n:t.dottedName,t),[u,l]=[null!==(r=e.dans)&&void 0!==r?r:[],null!==(a=e["sauf dans"])&&void 0!==a?a:[]].map(e=>Array.isArray(e)?e:[e]).map(e=>e.map(e=>Zn(e,t)));return{nodeKind:"replacementRule",rawNode:e,definitionRule:Zn(t.dottedName,t),replacedReference:o,replacementNode:i,whiteListedNames:u,blackListedNames:l,remplacementRuleId:En++}}):[]}function Kn(e,t){return kn(e,t).map(e=>Sn(Sn({},e),{},{replacementNode:xe(!1)}))}function An(e){return Object.values(e).flatMap(e=>e.replacements).reduce((e,t)=>{var n;if(!t.replacedReference.dottedName)throw new u(t);var r=t.replacedReference.dottedName;return Sn(Sn({},e),{},{[r]:[...null!==(n=e[r])&&void 0!==n?n:[],t]})},{})}function Rn(e,t){return p((t,n)=>{if("replacementRule"===t.nodeKind||"inversion"===t.nodeKind||"une possibilité"===t.nodeKind)return!1;if("recalcul"===t.nodeKind)return Sn(Sn({},t),{},{explanation:{recalcul:n(t.explanation.recalcul),amendedSituation:t.explanation.amendedSituation.map(e=>{var[t,r]=e;return[t,n(r)]})}});if("reference"===t.nodeKind){var r;if(!t.dottedName)throw new u(t);return function(e,t,n){var r,a=t.filter(t=>{var{definitionRule:n}=t;return n.dottedName!==e.contextDottedName}).filter(t=>{var{whiteListedNames:n}=t;return!n.length||n.some(t=>e.contextDottedName.startsWith(t.dottedName))}).filter(t=>{var{blackListedNames:n}=t;return!n.length||n.every(t=>!e.contextDottedName.startsWith(t.dottedName))}).sort((e,t)=>{var n=+!!t.whiteListedNames.length-+!!e.whiteListedNames.length,r=+!!t.blackListedNames.length-+!!e.blackListedNames.length;return n||r});if(!a.length)return e;if(a.length>1){!1}var o=a.map(e=>e.remplacementRuleId).join("-");return null!==(r=$n[o])&&void 0!==r||($n[o]={nodeKind:"variations",visualisationKind:"replacement",rawNode:e.rawNode,explanation:[...a.map(e=>({condition:e.definitionRule,consequence:e.replacementNode})),{condition:xe(!0),consequence:e}]}),$n[o]}(t,null!==(r=e[t.dottedName])&&void 0!==r?r:[])}})}var Un=e=>{var{style:t,maximumFractionDigits:n=2,minimumFractionDigits:r=0,language:a}=e;return e=>{var o="currency"===t&&n>=2&&0===r&&!Number.isInteger(e)?2:r;return Intl.NumberFormat(a,{style:t,currency:"EUR",maximumFractionDigits:n,minimumFractionDigits:o}).format(e)}};function Mn(e){var{maximumFractionDigits:t,minimumFractionDigits:n,language:r,formatUnit:a,unit:o,value:i}=e;if("number"!=typeof i)return i;var u=o?G(o,i,a):void 0;switch(u){case"€":return Un({style:"currency",maximumFractionDigits:t,minimumFractionDigits:n,language:r})(i);case"%":return Un({style:"percent",maximumFractionDigits:t,language:r})(i/100);default:return Un({style:"decimal",minimumFractionDigits:n,maximumFractionDigits:t,language:r})(i)+("string"==typeof u?" ".concat(u):"")}}function Tn(e){return e&&e[0].toUpperCase()+e.slice(1)}var qn={fr:{true:"Oui",false:"Non"},en:{true:"Yes",false:"No"}};function Ln(e){var{language:t="fr",displayedUnit:n,formatUnit:r,precision:a=2}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o="number"==typeof e||void 0===e?e:e.nodeValue,i=null!=n?n:"number"!=typeof e&&void 0!==e&&"unit"in e?e.unit:void 0;return"number"==typeof o&&Number.isNaN(o)||null==o?"-":"string"==typeof o?Tn(o.replace("\\n","\n")):"object"==typeof o?o.nom:"boolean"==typeof o?qn[t][o]:"number"==typeof o?Mn({minimumFractionDigits:0,maximumFractionDigits:a,language:t,formatUnit:r,unit:i,value:o}):null}function _n(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function In(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_n(Object(n),!0).forEach((function(t){Cn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_n(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Cn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Fn(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}function zn(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function Wn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Jn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Wn(Object(n),!0).forEach((function(t){Bn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Wn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Bn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Zn(e,t){null==e&&o(t.dottedName,"\nUne des valeurs de la formule est vide.\nVérifiez que tous les champs à droite des deux points sont remplis"),"boolean"==typeof e&&o(t.dottedName,"\nLes valeurs booléennes true / false ne sont acceptées.\nUtilisez leur contrepartie française : 'oui' / 'non'");var n="object"==typeof e?e:function(e,t){try{var[n]=new _.Parser(Gn).feed(e+"").results;return n}catch(n){o(t.dottedName,"`".concat(e,"` n'est pas une expression valide"),n)}}(e,t);return"nom"in n?function(e,t){var n,r,a=[t.dottedName,e.nom].filter(Boolean).join(" . "),o=Jt(a),i=Tn(null!==(n=e.titre)&&void 0!==n?n:t.ruleTitle?"".concat(t.ruleTitle," (").concat(o,")"):o);if(t.parsedRules[a])throw new Error("La référence '".concat(a,"' a déjà été définie"));var u=In(In(In({},Object.fromEntries(Object.entries(e).filter(e=>{var[t]=e;return Xn.includes(t)}))),"formule"in e&&{valeur:e.formule}),{},{"nom dans la situation":a}),l=In(In({},t),{},{dottedName:a,ruleTitle:i}),[c]=Gt(a),s={valeur:Zn(u,l),parent:!!c&&Zn(c,t)};return t.parsedRules[a]={dottedName:a,replacements:[...Kn(e["rend non applicable"],l),...kn(e.remplace,l)],title:i,suggestions:Object.fromEntries(Object.entries(null!==(r=e.suggestions)&&void 0!==r?r:{}).map(e=>{var[t,n]=e;return[t,Zn(n,l)]})),nodeKind:"rule",explanation:s,rawNode:e,virtualRule:!!t.dottedName},Zn(e.nom,t)}(n,t):Jn(Jn({},function(e,t){var n=Hn.find(t=>t.nom in e);if(!n)return Yn(e,t);var r=n.nom,{[r]:a}=e,o=Fn(e,[r].map(zn));return Yn({[n.nom]:{valeur:o,[n.nom]:a}},t)}(n,t)),{},{rawNode:e})}L("rule",(function(e){var t,n;if(this.cache[e.dottedName])return this.cache[e.dottedName];var r=In({},e.explanation),a=!this.cache._meta.ruleStack.includes(e.dottedName);this.cache._meta.ruleStack.unshift(e.dottedName);var o=null;r.parent&&a&&(o=this.evaluate(r.parent),r.parent=o);var i=null;o&&!1===o.nodeValue||(i=this.evaluate(r.valeur),r.valeur=i);var u=In(In({},e),{},{explanation:r,nodeValue:!(!i||!("nodeValue"in i))&&i.nodeValue,missingVariables:he(null===(t=i)||void 0===t?void 0:t.missingVariables,ge(null===(n=o)||void 0===n?void 0:n.missingVariables))},i&&"unit"in i&&{unit:i.unit});return this.cache._meta.ruleStack.shift(),this.cache[e.dottedName]=u,u}));var Gn=_.Grammar.fromCompiled(C.a);function Yn(e,t){Array.isArray(e)&&o(t.dottedName,"\nIl manque le nom du mécanisme pour le tableau : [".concat(e.map(e=>"'".concat(e,"'")).join(", "),"]\nLes mécanisme possibles sont : 'somme', 'le maximum de', 'le minimum de', 'toutes ces conditions', 'une de ces conditions'.\n\t\t"));var n=Object.keys(e);if(n.length>1&&o(t.dottedName,"\nLes mécanismes suivants se situent au même niveau : ".concat(n.map(e=>"'".concat(e,"'")).join(", "),"\nCela vient probablement d'une erreur dans l'indentation\n\t")),0===n.length)return{nodeKind:"constant",nodeValue:null};var r=Object.keys(e)[0],i=e[r],u=Qn[r];u||o(t.dottedName,"\nLe mécanisme ".concat(r," est inconnu.\nVérifiez qu'il n'y ait pas d'erreur dans l'orthographe du nom."));try{return(null==i?void 0:i.composantes)?((e,t,n)=>{var{composantes:r}=t,a=He(t,["composantes"]),o=Zn({somme:r.map(t=>{var{attributs:n}=t,r=He(t,["attributs"]);return Ge(Ge({},n),{},{[e]:Ge(Ge({},a),r)})})},n);return Ge(Ge({},o),{},{visualisationKind:"composantes"})})(r,i,t):(null==i?void 0:i.variations)&&Object.values(i).length>1?((e,t,n)=>{if("valeur"===e)return Zn(t,n);var{variations:r}=t,a=wn(t,["variations"]);return Zn({variations:r.map(t=>{var{alors:n,sinon:r,si:o}=t,i=null!=n?n:r,{attributs:u}=i,l=wn(i,["attributs"]);return gn({[void 0!==n?"alors":"sinon"]:gn(gn({},u),{},{[e]:gn(gn({},a),l)})},void 0!==o&&{si:o})})},n)})(r,i,t):u(i,t)}catch(e){if(e instanceof a)throw e;o(t.dottedName,r?"➡️ Dans le mécanisme ".concat(r,"\n").concat(e.message):e.message)}}var Hn=[Re,jt,Kt,Le,mn,_t,Mt,$e,an];var Qn=Jn(Jn(Jn({},Nt),Hn.reduce((e,t)=>Jn({[t.nom]:t},e),{})),{},{"une possibilité":(e,t)=>(Array.isArray(e)&&(e={"possibilités":e}),ht(ht({},e),{},{explanation:e.possibilités.map(e=>Zn(e,t)),nodeKind:"une possibilité",context:t.dottedName})),"inversion numérique":(e,t)=>{if(!e.avec)throw new Error("Une formule d'inversion doit préciser _avec_ quoi on peut inverser la variable");return bt(bt({explanation:{ruleToInverse:t.dottedName,inversionCandidates:e.avec.map(e=>Zn(e,t))}},"unité"in e&&{unit:B(e.unité,t.getUnitKey)}),{},{nodeKind:"inversion"})},recalcul:(e,t)=>{var n,r=Object.keys(e.avec).map(n=>[Zn(n,t),Zn(e.avec[n],t)]),a=t.dottedName;return{explanation:{recalcul:Zn(null!==(n=e.règle)&&void 0!==n?n:a,t),amendedSituation:r},nodeKind:"recalcul"}},variable:function(e,t){return{nodeKind:"reference",name:e,contextDottedName:t.dottedName}},"une de ces conditions":(e,t)=>{if(!Array.isArray(e))throw new Error("should be array");return{explanation:e.map(e=>Zn(e,t)),nodeKind:"une de ces conditions"}},"toutes ces conditions":(e,t)=>{if(!Array.isArray(e))throw new Error("should be array");return{explanation:e.map(e=>Zn(e,t)),nodeKind:"toutes ces conditions"}},somme:(e,t)=>({explanation:e.map(e=>Zn(e,t)),nodeKind:"somme"}),multiplication:Ft,produit:Ft,temporalValue:function(e,t){var n=Zn(e.explanation,t);return{nodeKind:"variable temporelle",explanation:{period:{start:e.period.start&&Zn(e.period.start,t),end:e.period.end&&Zn(e.period.end,t)},value:n}}},"barème":function(e,t){return{explanation:{assiette:Zn(e.assiette,t),multiplicateur:e.multiplicateur?Zn(e.multiplicateur,t):xe(1),tranches:Fe(e.tranches,t)},nodeKind:"barème"}},grille:function(e,t){return{explanation:{assiette:Zn(e.assiette,t),multiplicateur:e.multiplicateur?Zn(e.multiplicateur,t):xe(1),tranches:Fe(e.tranches,t)},nodeKind:"grille"}},"taux progressif":function(e,t){return{explanation:{assiette:Zn(e.assiette,t),multiplicateur:e.multiplicateur?Zn(e.multiplicateur,t):xe(1),tranches:Fe(e.tranches,t)},nodeKind:"taux progressif"}},"durée":(e,t)=>({explanation:De(ct,e,t),unit:B("jour"),nodeKind:"durée"}),"le maximum de":(e,t)=>({explanation:e.map(e=>Zn(e,t)),nodeKind:"maximum"}),"le minimum de":(e,t)=>({explanation:e.map(e=>Zn(e,t)),nodeKind:"minimum"}),variations:function(e,t){return{explanation:e.map(e=>{var{si:n,alors:r,sinon:a}=e;return void 0!==a?{consequence:Zn(a,t),condition:xe(!0)}:{consequence:Zn(r,t),condition:Zn(n,t)}}),nodeKind:"variations"}},synchronisation:(e,t)=>({explanation:un(un({},e),{},{data:Zn(e.data,t)}),nodeKind:"synchronisation"}),valeur:Zn,objet:e=>({type:"objet",nodeValue:e,nodeKind:"constant"}),constant:e=>({type:e.type,fullPrecision:!0,nodeValue:e.nodeValue,nodeKind:"constant"})}),Xn=Object.keys(Qn),er=n(5),tr=n.n(er);function nr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function rr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nr(Object(n),!0).forEach((function(t){ar(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ar(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function or(e){var t,n,r,a,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i="string"==typeof e?tr.a.parse((""+e).replace(/\t/g,"  ")):rr({},e);i=ir(i);var u={dottedName:null!==(t=o.dottedName)&&void 0!==t?t:"",parsedRules:null!==(n=o.parsedRules)&&void 0!==n?n:{},logger:null!==(r=o.logger)&&void 0!==r?r:console,getUnitKey:null!==(a=o.getUnitKey)&&void 0!==a?a:e=>e};Object.entries(i).forEach(e=>{var[t,n]=e;null==n&&(n={}),"object"!=typeof n&&(n={formule:""+n}),Zn(rr({nom:t},n),u)});var l=u.parsedRules,c=An(l=f(ur(l),l));return l=f(Rn(c,u.logger),l)}function ir(e){return Array.isArray(e)?e.map(ir):e&&"object"==typeof e?Object.entries(e).reduce((e,t)=>{var n,[r,a]=t,o=/\[ref( (.+))?\]$/.exec(r);if(!o)return rr(rr({},e),{},{[r]:ir(a)});var i=r.replace(o[0],"").trim(),u=(null===(n=o[2])||void 0===n?void 0:n.trim())||i;return rr(rr({},e),{},{[i]:{nom:u,valeur:ir(a)}})},{}):e}var ur=e=>p(t=>{if("reference"===t.nodeKind){var n=Yt(e,t.contextDottedName,t.name);return rr(rr({},t),{},{dottedName:n,title:e[n].title,acronym:e[n].rawNode.acronyme})}});function lr(e){if("number"==typeof e.nodeValue){var t=G(e.unit);return""+e.nodeValue+(t?t.replace(/\s/g,""):"")}return"boolean"==typeof e.nodeValue?e.nodeValue?"oui":"non":"string"==typeof e.nodeValue?"'".concat(e.nodeValue,"'"):void 0}function cr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function sr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cr(Object(n),!0).forEach((function(t){pr(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function pr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var dr=()=>({_meta:{ruleStack:[]},nodes:new Map});class fr{constructor(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};pr(this,"parsedRules",void 0),pr(this,"parsedSituation",{}),pr(this,"replacements",{}),pr(this,"cache",dr()),pr(this,"options",void 0),this.options=sr(sr({},n),{},{logger:null!==(e=n.logger)&&void 0!==e?e:console}),"string"==typeof t&&(t=or(t,this.options));var r=Object.values(t)[0];"object"==typeof r&&null!=r&&"nodeKind"in r||(t=or(t,this.options)),this.parsedRules=t,this.replacements=An(this.parsedRules)}setOptions(e){this.options=sr(sr({},this.options),e)}resetCache(){this.cache=dr()}setSituation(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.resetCache(),this.parsedSituation=Object.fromEntries(Object.entries(e).map(e=>{var[t,n]=e;return n&&"object"==typeof n&&"nodeKind"in n?[t,n]:[t,n&&"object"==typeof n&&"nodeKind"in n?n:this.parse(n,sr({dottedName:"situation [".concat(t,"]"),parsedRules:{}},this.options))]})),this}parse(){return Rn(this.replacements,this.options.logger)(ur(this.parsedRules)(Zn(...arguments)))}inversionFail(){return!!this.cache._meta.inversionFail}getRule(e){if(!(e in this.parsedRules))throw new Error("La règle '".concat(e,"' n'existe pas"));return this.parsedRules[e]}getParsedRules(){return this.parsedRules}evaluate(e){var t,n=this.cache.nodes.get(e);if(void 0!==n)return n;if(t=e&&"object"==typeof e&&"nodeKind"in e?e:this.parse(e,sr({dottedName:"evaluation",parsedRules:{}},this.options)),!q[t.nodeKind])throw Error('Unknown "nodeKind": '.concat(t.nodeKind));var r=q[t.nodeKind].call(this,t);return this.cache.nodes.set(e,r),r}}function br(e,t){var n=e.getRule(t);return d((function(r,a,o){return r||("nodeValue"in a?"variations"===a.nodeKind?a.explanation.some(e=>{var{consequence:n}=e;return o(n)||!1===n.nodeValue&&n.dottedName!==t}):"reference"===a.nodeKind&&a.dottedName===t?o(e.evaluate(n)):"applicable si"===a.nodeKind?!1===a.explanation.condition.nodeValue||o(a.explanation.valeur):"non applicable si"===a.nodeKind?!1!==a.explanation.condition.nodeValue&&null!==a.explanation.condition.nodeValue:"rule"===a.nodeKind?!1===a.explanation.parent.nodeValue||o(a.explanation.valeur):void 0:r)}),!1,e.evaluate(t))}}])}));